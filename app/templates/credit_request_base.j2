{% extends "base.j2" %}

{% from 'components/status.j2' import online_form_status_bar, empty_status_bar with context %}
{% from 'components/inputs.j2' import button with context %}

{% block content %}
<script type="module">
  import ApiController from "{{ url_for('static', path='js/apiController.js') }}";

  const onlineFormElement = document.getElementById("online-form");
  const onlineFormCancelButtonElement = document.getElementById("online-form-cancel-button");
  const stageContentElement = document.getElementById("stage-content");
  const apiController = ApiController.getInstance();
  let current_stage = "{{session.current_stage}}";

  const STAGES = [
    "credit_format",
    "personal_data",
    "family_status",
    "employment_income",
    "credit_details"
  ]

  async function renderOnlineFormStage(stage) {
    const html = await apiController.apiRenderOnlineFormStage(stage);
    html.replace("#step-number#", STAGES.indexOf(stage));
    stageContentElement.innerHTML = html;

    stageContentElement.querySelectorAll("script").forEach(oldScript => {
      const newScript = document.createElement('script');
      if (oldScript.type) newScript.type = oldScript.type;

      if (oldScript.src) {
        newScript.src = oldScript.src;
        document.head.appendChild(newScript);
      } else {
        newScript.textContent = oldScript.textContent;
        stageContentElement.appendChild(newScript);
      }

      oldScript.remove();
    });
  }

  function getNextStage(stage) {
    const newStageIndex = STAGES.indexOf(stage) + 1;
    if (newStageIndex > STAGES.length - 1) return "quit"
    return STAGES[newStageIndex]
  }

  function getPreviousStage(stage) {
    const newStageIndex = STAGES.indexOf(stage) - 1;
    if (newStageIndex < 0) return "quit"
    return STAGES[newStageIndex]
  }


  new Promise(async () => await renderOnlineFormStage(current_stage));

  async function onOnlineFormSubmit(event) {
    event.preventDefault();
    const nextStage = getNextStage(current_stage);
    await renderOnlineFormStage(nextStage)
    current_stage = nextStage;
  }

  async function onBackButtonPress(event) {
    const previousStage = getPreviousStage(current_stage);
    if (previousStage === "quit") { 
      window.location = "/";
      return;
    }
    await renderOnlineFormStage(previousStage)
    current_stage = previousStage;
  }

  function registerStatusBarClickEvents() {
    STAGES.forEach((stage) => {
      document.getElementById(`credit-{{credit.number}}-status-box-${stage}`)
              .addEventListener("click", async () => {
                await renderOnlineFormStage(stage);
              })
    });
  }

  registerStatusBarClickEvents();
  onlineFormElement.addEventListener("submit", onOnlineFormSubmit);
  onlineFormCancelButtonElement.addEventListener("click", onBackButtonPress);
</script>

{%- macro credit_request_header(title) -%}
  <div class="flex gap-1">
    <span class="text-2xl font-light">Schritt #step-number#:</span>
    <span class="text-2xl font-medium">{{title}}</span>
  </div>
{%- endmacro -%}

<div class="flex w-full h-[90vh] justify-center font-[IBMPlexSans]">
  <div class="flex w-4/5 bg-gray-100 h-[95%] mt-5 flex-col">
    <form class="flex flex-col justify-between h-full" id="online-form">
      <div class="flex flex-col">
        <div class="py-4 border-b-1 p-3 h-19 w-full flex flex-col gap-2">

          {{ online_form_status_bar(credit.number, credit.online_form_stages) }}
        </div>
        <div class="p-4" id="stage-content">
        </div>
      </div>
      <div class="flex justify-between w-full">
        {{ button("Zur√ºck", "cancel", "online-form-cancel-button") }}
        {{ button("Weiter", "submit") }}
      </div>
    </form>
  </div>
</div>
{% endblock content %}